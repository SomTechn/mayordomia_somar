<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f172a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Mayordom√≠a Financiera</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí∞</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0f1e;
            --bg-secondary: #111827;
            --bg-card: #1a2235;
            --bg-card-hover: #1f2a40;
            --bg-input: #0f172a;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-primary: #22d3ee;
            --accent-secondary: #818cf8;
            --accent-success: #34d399;
            --accent-warning: #fbbf24;
            --accent-danger: #f87171;
            --accent-spiritual: #c084fc;
            --border-color: rgba(148, 163, 184, 0.1);
            --shadow-glow: 0 0 20px rgba(34, 211, 238, 0.15);
            --radius: 16px;
            --radius-sm: 10px;
            --radius-xs: 6px;
            --font-main: 'DM Sans', sans-serif;
            --font-mono: 'Space Mono', monospace;
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: var(--font-main);
            background: var(--bg-primary);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
        }

        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--text-muted); border-radius: 4px; }

        /* ===== APP SHELL ===== */
        #app {
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            max-width: 480px;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
            background: var(--bg-primary);
        }

        #main-app {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        #auth-screen, #onboarding-screen {
            flex: 1;
            overflow-y: auto;
        }

        .app-header {
            padding: 16px 20px 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            z-index: 10;
            flex-shrink: 0;
        }

        .app-header h1 {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 18px;
        }

        .icon-btn:hover { background: var(--bg-card-hover); color: var(--text-primary); }

        /* ===== PAGE CONTENT ===== */
        .page-content {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 0 20px 120px;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        /* ===== BOTTOM NAV ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 480px;
            background: rgba(17, 24, 39, 0.98);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 8px 12px calc(12px + var(--safe-bottom));
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            padding: 6px 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-muted);
            border: none;
            background: none;
            font-family: var(--font-main);
        }

        .nav-item.active { color: var(--accent-primary); }
        .nav-item span { font-size: 20px; }
        .nav-item small { font-size: 10px; font-weight: 600; }

        .nav-fab {
            width: 52px;
            height: 52px;
            border-radius: 16px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border: none;
            font-size: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-top: -24px;
            box-shadow: 0 4px 20px rgba(34, 211, 238, 0.3);
            transition: all 0.2s;
        }

        .nav-fab:hover { transform: scale(1.05); }

        /* ===== CARDS ===== */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.2s;
        }

        .card-glow {
            box-shadow: var(--shadow-glow);
            border-color: rgba(34, 211, 238, 0.2);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* ===== BALANCE CARD ===== */
        .balance-card {
            background: linear-gradient(135deg, #1a2235 0%, #162032 50%, #1a1f3a 100%);
            border: 1px solid rgba(34, 211, 238, 0.15);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .balance-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(34, 211, 238, 0.05) 0%, transparent 60%);
            pointer-events: none;
        }

        .balance-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            font-weight: 500;
        }

        .balance-amount {
            font-family: var(--font-mono);
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -1px;
        }

        .balance-available {
            font-size: 14px;
            color: var(--accent-primary);
            margin-top: 4px;
            font-weight: 500;
        }

        .balance-row {
            display: flex;
            gap: 16px;
            margin-top: 20px;
        }

        .balance-stat {
            flex: 1;
            padding: 12px;
            background: rgba(255,255,255,0.03);
            border-radius: var(--radius-sm);
        }

        .balance-stat-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .balance-stat-value {
            font-family: var(--font-mono);
            font-size: 16px;
            font-weight: 700;
        }

        .stat-income { color: var(--accent-success); }
        .stat-expense { color: var(--accent-danger); }

        /* ===== ACCOUNT PILLS ===== */
        .accounts-scroll {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding: 4px 0 16px;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
        }

        .accounts-scroll::-webkit-scrollbar { display: none; }

        .account-pill {
            flex-shrink: 0;
            min-width: 160px;
            padding: 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            scroll-snap-align: start;
            cursor: pointer;
            transition: all 0.2s;
        }

        .account-pill:hover { border-color: rgba(34, 211, 238, 0.3); }

        .account-pill-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .account-pill-name {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .account-pill-balance {
            font-family: var(--font-mono);
            font-size: 16px;
            font-weight: 700;
        }

        /* ===== TRANSACTIONS LIST ===== */
        .transaction-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 0;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
        }

        .transaction-item:last-child { border-bottom: none; }

        .transaction-icon {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .transaction-info { flex: 1; min-width: 0; }

        .transaction-name {
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .transaction-category {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .transaction-amount {
            font-family: var(--font-mono);
            font-size: 15px;
            font-weight: 700;
            text-align: right;
        }

        .amount-income { color: var(--accent-success); }
        .amount-expense { color: var(--accent-danger); }
        .amount-transfer { color: var(--accent-secondary); }

        /* ===== FORMS ===== */
        .form-group {
            margin-bottom: 18px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: var(--font-main);
            font-size: 15px;
            outline: none;
            transition: all 0.2s;
        }

        .form-input:focus, .form-select:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.1);
        }

        .form-input::placeholder { color: var(--text-muted); }

        .form-select option { background: var(--bg-secondary); }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* ===== BUTTONS ===== */
        .btn {
            width: 100%;
            padding: 14px;
            border-radius: var(--radius-sm);
            border: none;
            font-family: var(--font-main);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), #06b6d4);
            color: #0a0f1e;
        }

        .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-danger {
            background: rgba(248, 113, 113, 0.1);
            color: var(--accent-danger);
            border: 1px solid rgba(248, 113, 113, 0.2);
        }

        .btn-spiritual {
            background: linear-gradient(135deg, var(--accent-spiritual), #a855f7);
            color: white;
        }

        .btn-sm { padding: 10px 16px; font-size: 13px; width: auto; }

        /* ===== MODAL ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 200;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 24px 24px 0 0;
            width: 100%;
            max-width: 480px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 24px 20px calc(24px + var(--safe-bottom));
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        .modal-handle {
            width: 40px;
            height: 4px;
            background: var(--text-muted);
            border-radius: 4px;
            margin: 0 auto 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        /* ===== SPIRITUAL BREAKDOWN ===== */
        .spiritual-breakdown {
            background: rgba(192, 132, 252, 0.08);
            border: 1px solid rgba(192, 132, 252, 0.2);
            border-radius: var(--radius);
            padding: 16px;
            margin: 16px 0;
        }

        .spiritual-breakdown h4 {
            color: var(--accent-spiritual);
            font-size: 14px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .spiritual-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }

        .spiritual-row span {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .spiritual-row strong {
            font-family: var(--font-mono);
            font-size: 14px;
            color: var(--accent-spiritual);
        }

        .spiritual-available {
            border-top: 1px solid rgba(192, 132, 252, 0.2);
            margin-top: 8px;
            padding-top: 10px;
        }

        .spiritual-available strong { color: var(--accent-success); }

        /* ===== TOGGLE ===== */
        .toggle-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
        }

        .toggle {
            position: relative;
            width: 48px;
            height: 26px;
            cursor: pointer;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            inset: 0;
            background: var(--bg-input);
            border-radius: 26px;
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--text-muted);
            top: 2px;
            left: 3px;
            transition: all 0.3s;
        }

        .toggle input:checked + .toggle-slider {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .toggle input:checked + .toggle-slider::before {
            background: white;
            transform: translateX(21px);
        }

        /* ===== PROGRESS BAR ===== */
        .progress-bar {
            height: 8px;
            background: var(--bg-input);
            border-radius: 8px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 8px;
            transition: width 0.5s ease;
        }

        /* ===== DEBT CARD ===== */
        .debt-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 18px;
            margin-bottom: 12px;
        }

        .debt-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .debt-creditor {
            font-size: 16px;
            font-weight: 600;
        }

        .debt-badge {
            font-size: 11px;
            padding: 3px 10px;
            border-radius: 20px;
            font-weight: 600;
        }

        .debt-badge.active {
            background: rgba(251, 191, 36, 0.1);
            color: var(--accent-warning);
        }

        .debt-badge.paid {
            background: rgba(52, 211, 153, 0.1);
            color: var(--accent-success);
        }

        .debt-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }

        .debt-info-item small {
            font-size: 11px;
            color: var(--text-muted);
        }

        .debt-info-item p {
            font-family: var(--font-mono);
            font-size: 14px;
            font-weight: 600;
            margin-top: 2px;
        }

        /* ===== BUDGET BARS ===== */
        .budget-item {
            padding: 14px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .budget-item:last-child { border-bottom: none; }

        .budget-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .budget-item-name {
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .budget-item-amounts {
            font-family: var(--font-mono);
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* ===== TABS ===== */
        .tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            padding: 4px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: var(--radius-xs);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-muted);
            border: none;
            background: none;
            font-family: var(--font-main);
        }

        .tab.active {
            background: var(--accent-primary);
            color: var(--bg-primary);
        }

        /* ===== SECTION TITLES ===== */
        .section-title {
            font-size: 16px;
            font-weight: 700;
            margin: 20px 0 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .section-title small {
            font-size: 13px;
            font-weight: 500;
            color: var(--accent-primary);
            cursor: pointer;
        }

        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .empty-state span { font-size: 48px; display: block; margin-bottom: 12px; }
        .empty-state p { font-size: 14px; }

        /* ===== AUTH SCREENS ===== */
        .auth-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            text-align: center;
        }

        .auth-logo {
            font-size: 56px;
            margin-bottom: 16px;
        }

        .auth-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 6px;
            letter-spacing: -0.5px;
        }

        .auth-subtitle {
            color: var(--text-secondary);
            font-size: 15px;
            margin-bottom: 32px;
        }

        .auth-form {
            width: 100%;
            max-width: 360px;
        }

        .auth-divider {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 20px 0;
            color: var(--text-muted);
            font-size: 13px;
        }

        .auth-divider::before, .auth-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border-color);
        }

        .auth-link {
            color: var(--accent-primary);
            cursor: pointer;
            font-weight: 500;
        }

        /* ===== ONBOARDING ===== */
        .onboarding-step {
            padding: 20px;
            text-align: center;
        }

        .onboarding-emoji {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .onboarding-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .onboarding-desc {
            color: var(--text-secondary);
            font-size: 15px;
            margin-bottom: 24px;
        }

        .currency-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .currency-option {
            padding: 16px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .currency-option.selected {
            border-color: var(--accent-primary);
            background: rgba(34, 211, 238, 0.05);
        }

        .currency-option span { font-size: 24px; display: block; margin-bottom: 6px; }
        .currency-option small { font-size: 13px; color: var(--text-secondary); }

        /* ===== SETTINGS ===== */
        .settings-group {
            margin-bottom: 24px;
        }

        .settings-group-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .settings-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .settings-item:hover { background: var(--bg-card-hover); }
        .settings-item span { font-size: 20px; }
        .settings-item p { flex: 1; font-size: 14px; }

        /* ===== CHIP SELECTOR ===== */
        .chip-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .chip {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .chip.active {
            background: var(--accent-primary);
            color: var(--bg-primary);
            border-color: var(--accent-primary);
        }

        /* ===== QUICK ACTIONS ===== */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .quick-action {
            padding: 16px 8px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-action:hover { border-color: rgba(34, 211, 238, 0.3); transform: translateY(-2px); }
        .quick-action span { font-size: 24px; display: block; margin-bottom: 6px; }
        .quick-action small { font-size: 11px; color: var(--text-secondary); font-weight: 500; }

        /* ===== NOTIFICATION BANNER ===== */
        .notification {
            position: fixed;
            top: 16px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 12px 20px;
            z-index: 300;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.3s ease;
            max-width: 90%;
        }

        .notification.show { transform: translateX(-50%) translateY(0); }
        .notification.success { border-color: rgba(52, 211, 153, 0.3); }
        .notification.error { border-color: rgba(248, 113, 113, 0.3); }

        /* ===== LOADING ===== */
        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* ===== FADE IN ===== */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in { animation: fadeIn 0.3s ease both; }

        /* ===== REPORTS ===== */
        .chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 16px;
        }

        .donut-chart {
            width: 180px;
            height: 180px;
            margin: 0 auto 16px;
            position: relative;
        }

        .donut-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .donut-center .amount {
            font-family: var(--font-mono);
            font-size: 18px;
            font-weight: 700;
        }

        .donut-center small {
            font-size: 11px;
            color: var(--text-muted);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .legend-label {
            flex: 1;
            font-size: 13px;
        }

        .legend-value {
            font-family: var(--font-mono);
            font-size: 13px;
            font-weight: 600;
        }

        /* ===== PAGE HIDDEN ===== */
        .page { display: none; }
        .page.active { display: block; }

        /* ===== RESPONSIVE ===== */
        @media (min-width: 481px) {
            #app {
                border-left: 1px solid var(--border-color);
                border-right: 1px solid var(--border-color);
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Auth Screen -->
        <div id="auth-screen" class="auth-screen">
            <div class="auth-logo">üí∞</div>
            <h1 class="auth-title">Mayordom√≠a</h1>
            <p class="auth-subtitle">Control financiero inteligente</p>
            <div class="auth-form">
                <div class="form-group">
                    <input type="email" class="form-input" id="auth-email" placeholder="Correo electr√≥nico">
                </div>
                <div class="form-group">
                    <input type="password" class="form-input" id="auth-password" placeholder="Contrase√±a">
                </div>
                <button class="btn btn-primary" id="btn-login">Iniciar Sesi√≥n</button>
                <div class="auth-divider">o</div>
                <button class="btn btn-secondary" id="btn-register">Crear Cuenta</button>
                <p style="margin-top: 16px; font-size: 13px; color: var(--text-muted)">
                    <span class="auth-link" id="btn-forgot">¬øOlvidaste tu contrase√±a?</span>
                </p>
            </div>
        </div>

        <!-- Onboarding Screen -->
        <div id="onboarding-screen" style="display:none">
            <div class="page-content" style="padding-top: 60px;">
                <div class="onboarding-step fade-in">
                    <div class="onboarding-emoji">üåü</div>
                    <h2 class="onboarding-title">¬°Bienvenido!</h2>
                    <p class="onboarding-desc">Configuremos tu cuenta para empezar a administrar tus finanzas sabiamente.</p>
                    
                    <div class="form-group" style="text-align: left;">
                        <label class="form-label">Tu nombre</label>
                        <input type="text" class="form-input" id="onb-name" placeholder="¬øC√≥mo te llamas?">
                    </div>

                    <div class="form-group" style="text-align: left;">
                        <label class="form-label">Moneda principal</label>
                        <div class="currency-grid">
                            <div class="currency-option selected" data-currency="HNL" onclick="selectCurrency(this)">
                                <span>üá≠üá≥</span>
                                <small>Lempiras (L)</small>
                            </div>
                            <div class="currency-option" data-currency="USD" onclick="selectCurrency(this)">
                                <span>üá∫üá∏</span>
                                <small>D√≥lares ($)</small>
                            </div>
                            <div class="currency-option" data-currency="EUR" onclick="selectCurrency(this)">
                                <span>üá™üá∫</span>
                                <small>Euros (‚Ç¨)</small>
                            </div>
                            <div class="currency-option" data-currency="GTQ" onclick="selectCurrency(this)">
                                <span>üá¨üáπ</span>
                                <small>Quetzales (Q)</small>
                            </div>
                        </div>
                    </div>

                    <div class="form-group" style="text-align: left;">
                        <div class="toggle-wrapper">
                            <div>
                                <p style="font-weight: 600; font-size: 15px;">‚úùÔ∏è M√≥dulo Espiritual</p>
                                <small style="color: var(--text-muted); font-size: 12px;">Diezmos, primicias y ofrendas</small>
                            </div>
                            <label class="toggle">
                                <input type="checkbox" id="onb-spiritual" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                    <div id="spiritual-config" style="text-align: left;">
                        <div class="form-group">
                            <label class="form-label">Porcentaje de diezmo</label>
                            <input type="number" class="form-input" id="onb-tithe" value="10" min="0" max="100">
                        </div>
                        <div class="toggle-wrapper">
                            <div>
                                <p style="font-weight: 500; font-size: 14px;">Primicias</p>
                                <small style="color: var(--text-muted); font-size: 12px;">Primer ingreso del mes/a√±o</small>
                            </div>
                            <label class="toggle">
                                <input type="checkbox" id="onb-firstfruits">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                    <button class="btn btn-primary" style="margin-top: 16px;" onclick="completeOnboarding()">
                        Comenzar üöÄ
                    </button>
                </div>
            </div>
        </div>

        <!-- Main App -->
        <div id="main-app" style="display:none;">
            <div class="app-header">
                <h1 id="page-title">Dashboard</h1>
                <div class="header-actions">
                    <button class="icon-btn" onclick="navigateTo('family')" title="Familia">üë®‚Äçüë©‚Äçüëß</button>
                    <button class="icon-btn" onclick="showNotificationsPanel()">üîî</button>
                    <button class="icon-btn" onclick="navigateTo('settings')">‚öôÔ∏è</button>
                </div>
            </div>

            <div class="page-content" id="page-container">
                <!-- === DASHBOARD PAGE === -->
                <div id="page-dashboard" class="page active">
                    <div class="balance-card card-glow">
                        <p class="balance-label">Balance Total</p>
                        <h2 class="balance-amount" id="total-balance">L 0.00</h2>
                        <p class="balance-available" id="available-balance">Disponible: L 0.00</p>
                        <div class="balance-row">
                            <div class="balance-stat">
                                <p class="balance-stat-label">Ingresos</p>
                                <p class="balance-stat-value stat-income" id="month-income">+L 0</p>
                            </div>
                            <div class="balance-stat">
                                <p class="balance-stat-label">Gastos</p>
                                <p class="balance-stat-value stat-expense" id="month-expenses">-L 0</p>
                            </div>
                        </div>
                    </div>

                    <div class="section-title">
                        <span>Mis Cuentas</span>
                        <small onclick="openAccountModal()">+ Agregar</small>
                    </div>
                    <div class="accounts-scroll" id="accounts-list"></div>

                    <div id="spiritual-summary" style="display:none">
                        <div class="section-title"><span>‚úùÔ∏è Mayordom√≠a Espiritual</span></div>
                        <div class="spiritual-breakdown">
                            <h4>üìä Resumen del Per√≠odo</h4>
                            <div class="spiritual-row">
                                <span>Diezmo pendiente</span>
                                <strong id="tithe-pending">L 0</strong>
                            </div>
                            <div class="spiritual-row">
                                <span>Ofrendas dadas</span>
                                <strong id="offerings-given">L 0</strong>
                            </div>
                            <div class="spiritual-row">
                                <span>Primicias</span>
                                <strong id="firstfruits-given">L 0</strong>
                            </div>
                        </div>
                    </div>

                    <div class="section-title">
                        <span>Acciones R√°pidas</span>
                    </div>
                    <div class="quick-actions">
                        <div class="quick-action" onclick="openTransactionModal('income')">
                            <span>üíµ</span>
                            <small>Ingreso</small>
                        </div>
                        <div class="quick-action" onclick="openTransactionModal('expense')">
                            <span>üõí</span>
                            <small>Gasto</small>
                        </div>
                        <div class="quick-action" onclick="openTransactionModal('transfer')">
                            <span>üîÑ</span>
                            <small>Transferir</small>
                        </div>
                    </div>

                    <div class="section-title">
                        <span>√öltimos Movimientos</span>
                        <small onclick="navigateTo('transactions')">Ver todo</small>
                    </div>
                    <div id="recent-transactions"></div>
                </div>

                <!-- === ACCOUNTS PAGE === -->
                <div id="page-accounts" class="page">
                    <div class="tabs" id="account-type-tabs">
                        <button class="tab active" data-filter="all" onclick="filterAccounts(this, 'all')">Todas</button>
                        <button class="tab" data-filter="bank" onclick="filterAccounts(this, 'bank')">Banco</button>
                        <button class="tab" data-filter="cash" onclick="filterAccounts(this, 'cash')">Efectivo</button>
                        <button class="tab" data-filter="savings" onclick="filterAccounts(this, 'savings')">Ahorro</button>
                    </div>
                    <div id="accounts-full-list"></div>
                    <button class="btn btn-secondary" style="margin-top: 16px;" onclick="openAccountModal()">
                        + Nueva Cuenta
                    </button>
                </div>

                <!-- === TRANSACTIONS PAGE === -->
                <div id="page-transactions" class="page">
                    <div class="tabs">
                        <button class="tab active" onclick="filterTransactions(this, 'all')">Todo</button>
                        <button class="tab" onclick="filterTransactions(this, 'income')">Ingresos</button>
                        <button class="tab" onclick="filterTransactions(this, 'expense')">Gastos</button>
                        <button class="tab" onclick="filterTransactions(this, 'transfer')">Transfer</button>
                    </div>
                    <div id="all-transactions"></div>
                </div>

                <!-- === DEBTS PAGE === -->
                <div id="page-debts" class="page">
                    <div class="section-title">
                        <span>Mis Deudas</span>
                        <small onclick="openDebtModal()">+ Nueva</small>
                    </div>
                    <div id="debts-summary" class="card" style="margin-bottom: 20px;">
                        <div class="form-row">
                            <div>
                                <p style="font-size: 12px; color: var(--text-muted);">Total Deudas</p>
                                <p id="total-debt" style="font-family: var(--font-mono); font-size: 20px; font-weight: 700; color: var(--accent-danger);">L 0</p>
                            </div>
                            <div>
                                <p style="font-size: 12px; color: var(--text-muted);">Cuota Mensual</p>
                                <p id="monthly-debt-payment" style="font-family: var(--font-mono); font-size: 20px; font-weight: 700; color: var(--accent-warning);">L 0</p>
                            </div>
                        </div>
                    </div>
                    <div id="debts-list"></div>
                </div>

                <!-- === BUDGETS PAGE === -->
                <div id="page-budgets" class="page">
                    <div class="section-title">
                        <span>Presupuestos del Mes</span>
                        <small onclick="openBudgetModal()">+ Nuevo</small>
                    </div>
                    <div id="budgets-list"></div>
                </div>

                <!-- === REPORTS PAGE === -->
                <div id="page-reports" class="page">
                    <div class="tabs">
                        <button class="tab active" onclick="setReportPeriod(this, 'month')">Mes</button>
                        <button class="tab" onclick="setReportPeriod(this, 'week')">Semana</button>
                        <button class="tab" onclick="setReportPeriod(this, 'year')">A√±o</button>
                    </div>
                    <div id="reports-content"></div>
                </div>

                <!-- === SETTINGS PAGE === -->
                <div id="page-settings" class="page">
                    <div class="settings-group">
                        <div class="settings-group-title">Perfil</div>
                        <div class="settings-item" onclick="openProfileEdit()">
                            <span>üë§</span>
                            <p>Editar Perfil</p>
                            <span style="color: var(--text-muted)">‚Ä∫</span>
                        </div>
                        <div class="settings-item">
                            <span>üí±</span>
                            <p>Moneda: <strong id="settings-currency">HNL</strong></p>
                            <span style="color: var(--text-muted)">‚Ä∫</span>
                        </div>
                    </div>
                    <div class="settings-group">
                        <div class="settings-group-title">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familia</div>
                        <div id="family-settings-content"></div>
                    </div>
                    <div class="settings-group">
                        <div class="settings-group-title">Mayordom√≠a Espiritual</div>
                        <div class="settings-item">
                            <span>‚úùÔ∏è</span>
                            <p>M√≥dulo Espiritual</p>
                            <label class="toggle">
                                <input type="checkbox" id="settings-spiritual" onchange="toggleSpiritual(this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div id="settings-spiritual-options">
                            <div class="settings-item">
                                <span>üìä</span>
                                <p>Diezmo: <strong id="settings-tithe">10</strong>%</p>
                                <span style="color: var(--text-muted)">‚Ä∫</span>
                            </div>
                        </div>
                    </div>
                    <div class="settings-group">
                        <div class="settings-group-title">Categor√≠as</div>
                        <div class="settings-item" onclick="openCategoriesManager()">
                            <span>üè∑Ô∏è</span>
                            <p>Gestionar Categor√≠as</p>
                            <span style="color: var(--text-muted)">‚Ä∫</span>
                        </div>
                    </div>
                    <div class="settings-group">
                        <div class="settings-group-title">Sesi√≥n</div>
                        <div class="settings-item" onclick="logout()" style="border-color: rgba(248,113,113,0.2);">
                            <span>üö™</span>
                            <p style="color: var(--accent-danger);">Cerrar Sesi√≥n</p>
                        </div>
                    </div>
                </div>

                <!-- === FAMILY PAGE === -->
                <div id="page-family" class="page">
                    <div id="family-no-group" style="display:none">
                        <div class="empty-state" style="padding-top:30px;">
                            <span>üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span>
                            <p style="margin-bottom:20px;">No perteneces a ninguna familia a√∫n</p>
                        </div>
                        <button class="btn btn-primary" style="margin-bottom:12px;" onclick="openCreateFamilyModal()">
                            üè† Crear Familia
                        </button>
                        <button class="btn btn-secondary" onclick="openJoinFamilyModal()">
                            üîó Unirse con C√≥digo
                        </button>
                    </div>

                    <div id="family-group" style="display:none">
                        <div class="card card-glow" style="margin-bottom:20px;">
                            <div style="display:flex;align-items:center;gap:14px;margin-bottom:16px;">
                                <div style="font-size:40px;">üè†</div>
                                <div style="flex:1;">
                                    <h3 id="family-name" style="font-size:18px;font-weight:700;"></h3>
                                    <p style="font-size:12px;color:var(--text-muted);">C√≥digo de invitaci√≥n:</p>
                                </div>
                            </div>
                            <div style="display:flex;align-items:center;gap:10px;background:var(--bg-input);padding:12px 16px;border-radius:var(--radius-sm);">
                                <code id="family-invite-code" style="font-family:var(--font-mono);font-size:18px;font-weight:700;letter-spacing:3px;flex:1;color:var(--accent-primary);"></code>
                                <button class="btn btn-sm btn-secondary" onclick="copyInviteCode()" style="width:auto;padding:8px 14px;">üìã Copiar</button>
                            </div>
                        </div>

                        <div class="section-title"><span>Miembros</span></div>
                        <div id="family-members-list"></div>

                        <div class="section-title" style="margin-top:24px;"><span>üìä Finanzas Familiares</span></div>
                        
                        <div class="card" style="margin-bottom:12px;">
                            <div class="form-row">
                                <div>
                                    <p style="font-size:12px;color:var(--text-muted);">Balance Familiar</p>
                                    <p id="family-total-balance" style="font-family:var(--font-mono);font-size:20px;font-weight:700;color:var(--accent-primary);">L 0</p>
                                </div>
                                <div>
                                    <p style="font-size:12px;color:var(--text-muted);">Deudas Familiar</p>
                                    <p id="family-total-debt" style="font-family:var(--font-mono);font-size:20px;font-weight:700;color:var(--accent-danger);">L 0</p>
                                </div>
                            </div>
                        </div>

                        <div id="family-member-summaries"></div>
                    </div>
                </div>
            </div>

            <!-- Bottom Navigation -->
            <nav class="bottom-nav">
                <button class="nav-item active" onclick="navigateTo('dashboard')" data-page="dashboard">
                    <span>üè†</span>
                    <small>Inicio</small>
                </button>
                <button class="nav-item" onclick="navigateTo('accounts')" data-page="accounts">
                    <span>üí≥</span>
                    <small>Cuentas</small>
                </button>
                <button class="nav-fab" onclick="openTransactionModal()">+</button>
                <button class="nav-item" onclick="navigateTo('debts')" data-page="debts">
                    <span>üìã</span>
                    <small>Deudas</small>
                </button>
                <button class="nav-item" onclick="navigateTo('reports')" data-page="reports">
                    <span>üìä</span>
                    <small>Reportes</small>
                </button>
            </nav>
        </div>

        <!-- MODALS -->
        <!-- Transaction Modal -->
        <div class="modal-overlay" id="modal-transaction">
            <div class="modal-content">
                <div class="modal-handle"></div>
                <h3 class="modal-title" id="transaction-modal-title">Nuevo Movimiento</h3>
                
                <div class="tabs" id="transaction-type-tabs">
                    <button class="tab active" onclick="setTransactionType(this, 'income')">Ingreso</button>
                    <button class="tab" onclick="setTransactionType(this, 'expense')">Gasto</button>
                    <button class="tab" onclick="setTransactionType(this, 'transfer')">Transfer</button>
                </div>

                <div class="form-group">
                    <label class="form-label">Monto</label>
                    <input type="number" class="form-input" id="tx-amount" placeholder="0.00" inputmode="decimal" step="0.01">
                </div>

                <div class="form-group">
                    <label class="form-label">Descripci√≥n</label>
                    <input type="text" class="form-input" id="tx-description" placeholder="¬øEn qu√©?">
                </div>

                <div class="form-group" id="tx-category-group">
                    <label class="form-label">Categor√≠a</label>
                    <select class="form-select" id="tx-category"></select>
                </div>

                <div class="form-group">
                    <label class="form-label" id="tx-account-label">Cuenta</label>
                    <select class="form-select" id="tx-account"></select>
                </div>

                <div class="form-group" id="tx-to-account-group" style="display:none">
                    <label class="form-label">Cuenta Destino</label>
                    <select class="form-select" id="tx-to-account"></select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Fecha</label>
                        <input type="date" class="form-input" id="tx-date">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Hora</label>
                        <input type="time" class="form-input" id="tx-time">
                    </div>
                </div>

                <!-- Photo Upload -->
                <div class="form-group">
                    <label class="form-label">üì∑ Foto de Respaldo (opcional)</label>
                    <div id="tx-photo-area" style="position:relative;">
                        <input type="file" id="tx-photo" accept="image/*" capture="environment" 
                            style="position:absolute;inset:0;opacity:0;cursor:pointer;z-index:2;" 
                            onchange="previewPhoto(this)">
                        <div id="tx-photo-placeholder" style="
                            border: 2px dashed var(--border-color);
                            border-radius: var(--radius-sm);
                            padding: 20px;
                            text-align: center;
                            color: var(--text-muted);
                            font-size: 13px;
                            transition: all 0.2s;
                        ">
                            üì∏ Toca para tomar foto o seleccionar imagen
                        </div>
                        <div id="tx-photo-preview" style="display:none; position:relative;">
                            <img id="tx-photo-img" style="width:100%;max-height:200px;object-fit:cover;border-radius:var(--radius-sm);">
                            <button onclick="clearPhoto()" style="
                                position:absolute;top:8px;right:8px;
                                background:rgba(0,0,0,0.7);color:white;
                                border:none;border-radius:50%;width:28px;height:28px;
                                font-size:14px;cursor:pointer;z-index:3;
                            ">‚úï</button>
                        </div>
                    </div>
                </div>

                <!-- Spiritual Allocation Preview -->
                <div id="tx-spiritual-preview" style="display:none">
                    <div class="spiritual-breakdown">
                        <h4>‚úùÔ∏è Distribuci√≥n Sugerida</h4>
                        <div class="spiritual-row">
                            <span>Diezmo (<span id="tx-tithe-pct">10</span>%)</span>
                            <strong id="tx-tithe-amount">L 0</strong>
                        </div>
                        <div class="spiritual-row spiritual-available">
                            <span>Disponible despu√©s</span>
                            <strong id="tx-available-after">L 0</strong>
                        </div>
                    </div>
                </div>

                <div id="tx-saving-indicator" style="display:none; text-align:center; padding:10px;">
                    <div class="loading-spinner"></div>
                    <small style="color:var(--text-muted);">Guardando...</small>
                </div>

                <div class="form-row" style="margin-top: 8px;" id="tx-buttons">
                    <button class="btn btn-secondary" onclick="closeModal('modal-transaction')">Cancelar</button>
                    <button class="btn btn-primary" id="btn-save-tx" onclick="saveTransaction()">Guardar</button>
                </div>
            </div>
        </div>

        <!-- Account Modal -->
        <div class="modal-overlay" id="modal-account">
            <div class="modal-content">
                <div class="modal-handle"></div>
                <h3 class="modal-title">Nueva Cuenta</h3>
                
                <div class="form-group">
                    <label class="form-label">Nombre de la cuenta</label>
                    <input type="text" class="form-input" id="acc-name" placeholder="Ej: BAC Credomatic">
                </div>

                <div class="form-group">
                    <label class="form-label">Tipo</label>
                    <select class="form-select" id="acc-type">
                        <option value="bank">üè¶ Cuenta Bancaria</option>
                        <option value="cash">üíµ Efectivo</option>
                        <option value="savings">üí∞ Ahorro</option>
                        <option value="tithe">üìñ Fondo Diezmo</option>
                        <option value="offering">üôè Fondo Ofrenda</option>
                        <option value="firstfruits">üåæ Fondo Primicias</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Saldo Inicial</label>
                    <input type="number" class="form-input" id="acc-balance" placeholder="0.00" inputmode="decimal" step="0.01">
                </div>

                <div class="form-group" id="acc-goal-group" style="display:none">
                    <label class="form-label">Meta de Ahorro (opcional)</label>
                    <input type="number" class="form-input" id="acc-goal" placeholder="0.00" inputmode="decimal">
                </div>

                <div class="form-row" style="margin-top: 8px;">
                    <button class="btn btn-secondary" onclick="closeModal('modal-account')">Cancelar</button>
                    <button class="btn btn-primary" onclick="saveAccount()">Crear</button>
                </div>
            </div>
        </div>

        <!-- Debt Modal -->
        <div class="modal-overlay" id="modal-debt">
            <div class="modal-content">
                <div class="modal-handle"></div>
                <h3 class="modal-title">Nueva Deuda</h3>
                
                <div class="form-group">
                    <label class="form-label">Acreedor</label>
                    <input type="text" class="form-input" id="debt-creditor" placeholder="Ej: BAC, Ficohsa, Juan...">
                </div>

                <div class="form-group">
                    <label class="form-label">Monto Original</label>
                    <input type="number" class="form-input" id="debt-original" placeholder="0.00" inputmode="decimal">
                </div>

                <div class="form-group">
                    <label class="form-label">Saldo Actual</label>
                    <input type="number" class="form-input" id="debt-balance" placeholder="0.00" inputmode="decimal">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Tasa Inter√©s %</label>
                        <input type="number" class="form-input" id="debt-interest" placeholder="0" inputmode="decimal">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cuota Mensual</label>
                        <input type="number" class="form-input" id="debt-payment" placeholder="0.00" inputmode="decimal">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">D√≠a de Pago</label>
                    <input type="number" class="form-input" id="debt-due-day" placeholder="15" min="1" max="31">
                </div>

                <div class="form-row" style="margin-top: 8px;">
                    <button class="btn btn-secondary" onclick="closeModal('modal-debt')">Cancelar</button>
                    <button class="btn btn-primary" onclick="saveDebt()">Crear</button>
                </div>
            </div>
        </div>

        <!-- Budget Modal -->
        <div class="modal-overlay" id="modal-budget">
            <div class="modal-content">
                <div class="modal-handle"></div>
                <h3 class="modal-title">Nuevo Presupuesto</h3>
                
                <div class="form-group">
                    <label class="form-label">Categor√≠a</label>
                    <select class="form-select" id="budget-category"></select>
                </div>

                <div class="form-group">
                    <label class="form-label">Monto Presupuestado</label>
                    <input type="number" class="form-input" id="budget-amount" placeholder="0.00" inputmode="decimal">
                </div>

                <div class="form-row" style="margin-top: 8px;">
                    <button class="btn btn-secondary" onclick="closeModal('modal-budget')">Cancelar</button>
                    <button class="btn btn-primary" onclick="saveBudget()">Crear</button>
                </div>
            </div>
        </div>

        <!-- Debt Payment Modal -->
        <div class="modal-overlay" id="modal-debt-payment">
            <div class="modal-content">
                <div class="modal-handle"></div>
                <h3 class="modal-title">Registrar Abono</h3>
                
                <div class="form-group">
                    <label class="form-label">Monto del Abono</label>
                    <input type="number" class="form-input" id="dp-amount" placeholder="0.00" inputmode="decimal">
                </div>

                <div class="form-group">
                    <label class="form-label">Desde Cuenta</label>
                    <select class="form-select" id="dp-account"></select>
                </div>

                <div class="form-group">
                    <label class="form-label">Nota (opcional)</label>
                    <input type="text" class="form-input" id="dp-note" placeholder="Cuota mensual, abono extra...">
                </div>

                <input type="hidden" id="dp-debt-id">

                <div class="form-row" style="margin-top: 8px;">
                    <button class="btn btn-secondary" onclick="closeModal('modal-debt-payment')">Cancelar</button>
                    <button class="btn btn-primary" onclick="saveDebtPayment()">Registrar</button>
                </div>
            </div>
        </div>

        <!-- Create Family Modal -->
        <div class="modal-overlay" id="modal-create-family">
            <div class="modal-content">
                <div class="modal-handle"></div>
                <h3 class="modal-title">üè† Crear Familia</h3>
                <div class="form-group">
                    <label class="form-label">Nombre de la Familia</label>
                    <input type="text" class="form-input" id="family-create-name" placeholder="Ej: Familia Mart√≠nez">
                </div>
                <div class="form-row" style="margin-top: 8px;">
                    <button class="btn btn-secondary" onclick="closeModal('modal-create-family')">Cancelar</button>
                    <button class="btn btn-primary" onclick="createFamily()">Crear</button>
                </div>
            </div>
        </div>

        <!-- Join Family Modal -->
        <div class="modal-overlay" id="modal-join-family">
            <div class="modal-content">
                <div class="modal-handle"></div>
                <h3 class="modal-title">üîó Unirse a Familia</h3>
                <p style="font-size:14px;color:var(--text-secondary);margin-bottom:16px;">Pide el c√≥digo de invitaci√≥n al administrador de la familia.</p>
                <div class="form-group">
                    <label class="form-label">C√≥digo de Invitaci√≥n</label>
                    <input type="text" class="form-input" id="family-join-code" placeholder="Ej: a1b2c3d4" maxlength="8" style="font-family:var(--font-mono);font-size:20px;text-align:center;letter-spacing:4px;">
                </div>
                <div class="form-row" style="margin-top: 8px;">
                    <button class="btn btn-secondary" onclick="closeModal('modal-join-family')">Cancelar</button>
                    <button class="btn btn-primary" onclick="joinFamily()">Unirme</button>
                </div>
            </div>
        </div>

        <!-- Notification Toast -->
        <div class="notification" id="toast"></div>
    </div>

    <!-- SUPABASE SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
    // ========================
    // CONFIGURATION
    // ========================
    const SUPABASE_URL = 'https://sjsddpprukasftzevfzk.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqc2RkcHBydWthc2Z0emV2ZnprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxNDgzMDEsImV4cCI6MjA4NzcyNDMwMX0.TGXLEkBuN5PGIkFa4opWr0eVI0lWgBYQm-t8YCpLYH0';
    
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ========================
    // STATE
    // ========================
    let currentUser = null;
    let userProfile = null;
    let accounts = [];
    let transactions = [];
    let categories = [];
    let debts = [];
    let budgets = [];
    let currentPage = 'dashboard';
    let currentTxType = 'income';
    let currentTxFilter = 'all';
    let currentAccountFilter = 'all';
    let reportPeriod = 'month';

    const CURRENCY_SYMBOLS = { HNL: 'L', USD: '$', EUR: '‚Ç¨', GTQ: 'Q' };

    const DEFAULT_CATEGORIES = [
        { name: 'Salario', type: 'income', icon: 'üíº' },
        { name: 'Freelance', type: 'income', icon: 'üíª' },
        { name: 'Negocio', type: 'income', icon: 'üè™' },
        { name: 'Regalo', type: 'income', icon: 'üéÅ' },
        { name: 'Otro Ingreso', type: 'income', icon: 'üí∞' },
        { name: 'Combustible', type: 'expense', icon: '‚õΩ' },
        { name: 'Internet M√≥vil', type: 'expense', icon: 'üì±' },
        { name: 'Wifi', type: 'expense', icon: 'üì∂' },
        { name: 'Colegiatura', type: 'expense', icon: 'üéì' },
        { name: 'Carro', type: 'expense', icon: 'üöó' },
        { name: 'Moto', type: 'expense', icon: 'üèçÔ∏è' },
        { name: 'Pr√©stamo', type: 'expense', icon: 'üè¶' },
        { name: 'Supermercado', type: 'expense', icon: 'üõí' },
        { name: 'Pulper√≠a', type: 'expense', icon: 'üè™' },
        { name: 'Chucher√≠as', type: 'expense', icon: 'üç¨' },
        { name: 'Comidas Fuera', type: 'expense', icon: 'üçî' },
        { name: 'Alquiler', type: 'expense', icon: 'üè†' },
        { name: 'Electricidad', type: 'expense', icon: 'üí°' },
        { name: 'Agua', type: 'expense', icon: 'üíß' },
        { name: 'Salud', type: 'expense', icon: 'üè•' },
        { name: 'Transporte', type: 'expense', icon: 'üöå' },
        { name: 'Entretenimiento', type: 'expense', icon: 'üé¨' },
        { name: 'Ropa', type: 'expense', icon: 'üëï' },
        { name: 'Educaci√≥n', type: 'expense', icon: 'üìö' },
        { name: 'Diezmo', type: 'expense', icon: '‚õ™' },
        { name: 'Ofrenda', type: 'expense', icon: 'üôè' },
        { name: 'Primicias', type: 'expense', icon: 'üåæ' },
        { name: 'Otro Gasto', type: 'expense', icon: 'üìù' },
    ];

    const ACCOUNT_ICONS = {
        bank: 'üè¶', cash: 'üíµ', savings: 'üí∞',
        tithe: 'üìñ', offering: 'üôè', firstfruits: 'üåæ'
    };

    // ========================
    // HELPERS
    // ========================
    const HN_TZ = 'America/Tegucigalpa';

    function hnNow() {
        return new Date(new Date().toLocaleString('en-US', { timeZone: HN_TZ }));
    }

    function fmt(amount) {
        const sym = CURRENCY_SYMBOLS[userProfile?.currency || 'HNL'] || 'L';
        return `${sym} ${parseFloat(amount || 0).toLocaleString('es-HN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }

    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        toast.textContent = (type === 'success' ? '‚úÖ ' : '‚ùå ') + message;
        toast.className = `notification show ${type}`;
        setTimeout(() => toast.className = 'notification', 3000);
    }

    function openModal(id) {
        document.getElementById(id).classList.add('active');
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove('active');
    }

    function todayStr() {
        const now = new Date();
        const hn = new Date(now.toLocaleString('en-US', { timeZone: HN_TZ }));
        const y = hn.getFullYear();
        const m = String(hn.getMonth() + 1).padStart(2, '0');
        const d = String(hn.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    }

    function nowTimeStr() {
        const now = hnNow();
        return now.toTimeString().slice(0, 5); // HH:MM
    }

    function formatDateHN(dateStr, timeStr) {
        if (!dateStr) return '';
        const d = new Date(dateStr + 'T' + (timeStr || '12:00') + ':00');
        return d.toLocaleDateString('es-HN', { day: 'numeric', month: 'short', timeZone: HN_TZ });
    }

    function formatTimeHN(createdAt) {
        if (!createdAt) return '';
        const d = new Date(createdAt);
        return d.toLocaleTimeString('es-HN', { hour: '2-digit', minute: '2-digit', hour12: true, timeZone: HN_TZ });
    }

    function formatFullDateHN(createdAt) {
        if (!createdAt) return '';
        const d = new Date(createdAt);
        return d.toLocaleDateString('es-HN', { weekday: 'long', day: 'numeric', month: 'long', timeZone: HN_TZ });
    }

    function getMonthRange() {
        const now = hnNow();
        const y = now.getFullYear();
        const m = now.getMonth();
        const startDay = new Date(y, m, 1);
        const endDay = new Date(y, m + 1, 0);
        const start = `${y}-${String(m + 1).padStart(2, '0')}-01`;
        const end = `${y}-${String(m + 1).padStart(2, '0')}-${String(endDay.getDate()).padStart(2, '0')}`;
        return { start, end };
    }

    // Photo helpers
    let currentPhotoFile = null;

    function previewPhoto(input) {
        const file = input.files[0];
        if (!file) return;
        currentPhotoFile = file;
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('tx-photo-img').src = e.target.result;
            document.getElementById('tx-photo-preview').style.display = 'block';
            document.getElementById('tx-photo-placeholder').style.display = 'none';
        };
        reader.readAsDataURL(file);
    }

    function clearPhoto() {
        currentPhotoFile = null;
        document.getElementById('tx-photo').value = '';
        document.getElementById('tx-photo-preview').style.display = 'none';
        document.getElementById('tx-photo-placeholder').style.display = 'block';
    }

    async function uploadPhoto(file) {
        if (!file) return null;
        try {
            const ext = file.name.split('.').pop() || 'jpg';
            const fileName = `${currentUser.id}/${Date.now()}.${ext}`;
            const { data, error } = await supabaseClient.storage.from('receipts').upload(fileName, file, {
                cacheControl: '3600',
                upsert: false
            });
            if (error) {
                console.warn('Photo upload error:', error.message);
                return null;
            }
            const { data: urlData } = supabaseClient.storage.from('receipts').getPublicUrl(fileName);
            return urlData?.publicUrl || null;
        } catch (err) {
            console.warn('Photo upload failed:', err);
            return null;
        }
    }

    // ========================
    // AUTH
    // ========================
    document.getElementById('btn-login').onclick = async () => {
        const email = document.getElementById('auth-email').value.trim();
        const password = document.getElementById('auth-password').value;
        if (!email || !password) return showToast('Completa todos los campos', 'error');
        
        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) return showToast(error.message, 'error');
        currentUser = data.user;
        await checkProfile();
    };

    document.getElementById('btn-register').onclick = async () => {
        const email = document.getElementById('auth-email').value.trim();
        const password = document.getElementById('auth-password').value;
        if (!email || !password) return showToast('Completa todos los campos', 'error');
        if (password.length < 6) return showToast('La contrase√±a debe tener al menos 6 caracteres', 'error');
        
        const { data, error } = await supabaseClient.auth.signUp({ email, password });
        if (error) return showToast(error.message, 'error');
        currentUser = data.user;
        showOnboarding();
    };

    document.getElementById('btn-forgot').onclick = async () => {
        const email = document.getElementById('auth-email').value.trim();
        if (!email) return showToast('Ingresa tu correo primero', 'error');
        const { error } = await supabaseClient.auth.resetPasswordForEmail(email);
        if (error) return showToast(error.message, 'error');
        showToast('Se envi√≥ un enlace a tu correo');
    };

    async function logout() {
        await supabaseClient.auth.signOut();
        currentUser = null;
        userProfile = null;
        document.getElementById('main-app').style.display = 'none';
        document.getElementById('auth-screen').style.display = 'flex';
    }

    // ========================
    // PROFILE CHECK
    // ========================
    async function checkProfile() {
        const { data } = await supabaseClient.from('users').select('*').eq('id', currentUser.id).maybeSingle();
        if (data) {
            userProfile = data;
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';
            await loadAllData();
        } else {
            showOnboarding();
        }
    }

    // ========================
    // ONBOARDING
    // ========================
    function showOnboarding() {
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('onboarding-screen').style.display = 'block';
    }

    function selectCurrency(el) {
        document.querySelectorAll('.currency-option').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
    }

    document.getElementById('onb-spiritual').addEventListener('change', function() {
        document.getElementById('spiritual-config').style.display = this.checked ? 'block' : 'none';
    });

    document.getElementById('acc-type').addEventListener('change', function() {
        document.getElementById('acc-goal-group').style.display = this.value === 'savings' ? 'block' : 'none';
    });

    async function completeOnboarding() {
        const name = document.getElementById('onb-name').value.trim();
        if (!name) return showToast('Ingresa tu nombre', 'error');

        const currency = document.querySelector('.currency-option.selected')?.dataset.currency || 'HNL';
        const spiritualEnabled = document.getElementById('onb-spiritual').checked;
        const tithePercentage = parseFloat(document.getElementById('onb-tithe').value) || 10;
        const firstfruitsEnabled = document.getElementById('onb-firstfruits').checked;

        const profile = {
            id: currentUser.id,
            email: currentUser.email,
            full_name: name,
            currency,
            spiritual_module_enabled: spiritualEnabled,
            tithe_percentage: tithePercentage,
            firstfruits_enabled: firstfruitsEnabled,
            period_type: 'monthly',
            period_start_day: 1,
        };

        const { error } = await supabaseClient.from('users').upsert(profile, { onConflict: 'id' });
        if (error) return showToast('Error al crear perfil: ' + error.message, 'error');

        userProfile = profile;

        // Create default categories (only if none exist)
        const { data: existingCats } = await supabaseClient.from('categories').select('id').eq('user_id', currentUser.id).limit(1);
        if (!existingCats || existingCats.length === 0) {
            const cats = DEFAULT_CATEGORIES.map(c => ({
                user_id: currentUser.id,
                name: c.name,
                type: c.type,
                icon: c.icon,
                is_default: true
            }));
            await supabaseClient.from('categories').insert(cats);
        }

        // Create default accounts (only if none exist)
        const { data: existingAccs } = await supabaseClient.from('accounts').select('id').eq('user_id', currentUser.id).limit(1);
        if (!existingAccs || existingAccs.length === 0) {
            const defaultAccounts = [
                { user_id: currentUser.id, name: 'Efectivo', type: 'cash', balance: 0, icon: 'üíµ', color: '#34d399', is_active: true },
                { user_id: currentUser.id, name: 'Banco Principal', type: 'bank', balance: 0, icon: 'üè¶', color: '#818cf8', is_active: true },
            ];
            if (spiritualEnabled) {
                defaultAccounts.push(
                    { user_id: currentUser.id, name: 'Fondo Diezmo', type: 'tithe', balance: 0, icon: 'üìñ', color: '#c084fc', is_active: true },
                    { user_id: currentUser.id, name: 'Fondo Ofrenda', type: 'offering', balance: 0, icon: 'üôè', color: '#a78bfa', is_active: true }
                );
            }
            await supabaseClient.from('accounts').insert(defaultAccounts);
        }

        document.getElementById('onboarding-screen').style.display = 'none';
        document.getElementById('main-app').style.display = 'flex';
        await loadAllData();
        showToast('¬°Cuenta creada exitosamente!');
    }

    // ========================
    // DATA LOADING
    // ========================
    async function loadAllData() {
        await Promise.all([
            loadAccounts(),
            loadCategories(),
            loadTransactions(),
            loadDebts(),
            loadBudgets(),
            loadFamilyData()
        ]);
        renderDashboard();
        updateSettingsUI();
    }

    async function loadAccounts() {
        const { data } = await supabaseClient.from('accounts').select('*')
            .eq('user_id', currentUser.id).eq('is_active', true).order('created_at');
        accounts = data || [];
    }

    async function loadCategories() {
        const { data } = await supabaseClient.from('categories').select('*')
            .eq('user_id', currentUser.id).order('name');
        categories = data || [];
    }

    async function loadTransactions() {
        const { data } = await supabaseClient.from('transactions').select('*, categories(name, icon)')
            .eq('user_id', currentUser.id).order('date', { ascending: false }).order('created_at', { ascending: false }).limit(200);
        transactions = data || [];
    }

    async function loadDebts() {
        const { data } = await supabaseClient.from('debts').select('*')
            .eq('user_id', currentUser.id).order('created_at', { ascending: false });
        debts = data || [];
    }

    async function loadBudgets() {
        const now = new Date();
        const { data } = await supabaseClient.from('budgets').select('*, categories(name, icon)')
            .eq('user_id', currentUser.id).eq('month', now.getMonth() + 1).eq('year', now.getFullYear());
        budgets = data || [];
    }

    // ========================
    // NAVIGATION
    // ========================
    function navigateTo(page) {
        currentPage = page;
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(`page-${page}`).classList.add('active');
        
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.querySelector(`.nav-item[data-page="${page}"]`)?.classList.add('active');

        const titles = {
            dashboard: 'Dashboard', accounts: 'Mis Cuentas', transactions: 'Movimientos',
            debts: 'Deudas', budgets: 'Presupuestos', reports: 'Reportes', settings: 'Configuraci√≥n',
            family: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familia'
        };
        document.getElementById('page-title').textContent = titles[page] || 'Mayordom√≠a';

        // Render page-specific content
        if (page === 'dashboard') renderDashboard();
        else if (page === 'accounts') renderAccountsPage();
        else if (page === 'transactions') renderTransactionsPage();
        else if (page === 'debts') renderDebtsPage();
        else if (page === 'budgets') renderBudgetsPage();
        else if (page === 'reports') renderReports();
        else if (page === 'family') renderFamilyPage();
    }

    // ========================
    // DASHBOARD RENDER
    // ========================
    function renderDashboard() {
        // Total balance
        const totalBalance = accounts.reduce((sum, a) => sum + parseFloat(a.balance || 0), 0);
        const spiritualAccounts = accounts.filter(a => ['tithe', 'offering', 'firstfruits'].includes(a.type));
        const spiritualTotal = spiritualAccounts.reduce((sum, a) => sum + parseFloat(a.balance || 0), 0);
        const available = totalBalance - spiritualTotal;

        document.getElementById('total-balance').textContent = fmt(totalBalance);
        document.getElementById('available-balance').textContent = `Disponible: ${fmt(available)}`;

        // Month income/expenses
        const { start, end } = getMonthRange();
        const monthTxs = transactions.filter(t => t.date >= start && t.date <= end);
        const monthIncome = monthTxs.filter(t => t.type === 'income').reduce((s, t) => s + parseFloat(t.amount), 0);
        const monthExpense = monthTxs.filter(t => t.type === 'expense').reduce((s, t) => s + parseFloat(t.amount), 0);
        
        const sym = CURRENCY_SYMBOLS[userProfile?.currency || 'HNL'];
        document.getElementById('month-income').textContent = `+${sym} ${monthIncome.toLocaleString('es-HN', {minimumFractionDigits: 0})}`;
        document.getElementById('month-expenses').textContent = `-${sym} ${monthExpense.toLocaleString('es-HN', {minimumFractionDigits: 0})}`;

        // Accounts scroll
        const accList = document.getElementById('accounts-list');
        if (accounts.length === 0) {
            accList.innerHTML = '<div class="empty-state"><p>Agrega tu primera cuenta</p></div>';
        } else {
            accList.innerHTML = accounts.map(a => `
                <div class="account-pill" onclick="navigateTo('accounts')">
                    <div class="account-pill-icon">${ACCOUNT_ICONS[a.type] || 'üí≥'}</div>
                    <div class="account-pill-name">${a.name}</div>
                    <div class="account-pill-balance">${fmt(a.balance)}</div>
                </div>
            `).join('');
        }

        // Spiritual summary
        if (userProfile?.spiritual_module_enabled) {
            document.getElementById('spiritual-summary').style.display = 'block';
            const tithePending = monthIncome * (userProfile.tithe_percentage / 100);
            const tithePaid = monthTxs.filter(t => t.type === 'expense' && categories.find(c => c.id === t.category_id)?.name === 'Diezmo')
                .reduce((s, t) => s + parseFloat(t.amount), 0);
            const offeringsPaid = monthTxs.filter(t => t.type === 'expense' && categories.find(c => c.id === t.category_id)?.name === 'Ofrenda')
                .reduce((s, t) => s + parseFloat(t.amount), 0);

            document.getElementById('tithe-pending').textContent = fmt(Math.max(0, tithePending - tithePaid));
            document.getElementById('offerings-given').textContent = fmt(offeringsPaid);
            document.getElementById('firstfruits-given').textContent = fmt(0);
        } else {
            document.getElementById('spiritual-summary').style.display = 'none';
        }

        // Recent transactions
        const recentTx = document.getElementById('recent-transactions');
        const recent = transactions.slice(0, 8);
        if (recent.length === 0) {
            recentTx.innerHTML = '<div class="empty-state"><span>üìù</span><p>No hay movimientos a√∫n</p></div>';
        } else {
            recentTx.innerHTML = recent.map(t => renderTransactionItem(t)).join('');
        }
    }

    function renderTransactionItem(t) {
        const cat = categories.find(c => c.id === t.category_id);
        const icon = cat?.icon || (t.type === 'transfer' ? 'üîÑ' : 'üìù');
        const catName = cat?.name || (t.type === 'transfer' ? 'Transferencia' : '');
        const amountClass = t.type === 'income' ? 'amount-income' : t.type === 'expense' ? 'amount-expense' : 'amount-transfer';
        const prefix = t.type === 'income' ? '+' : t.type === 'expense' ? '-' : '';
        const bgColor = t.type === 'income' ? 'rgba(52,211,153,0.1)' : t.type === 'expense' ? 'rgba(248,113,113,0.1)' : 'rgba(129,140,248,0.1)';
        
        const dateDisplay = formatDateHN(t.date, t.time);
        const timeDisplay = t.time ? t.time : formatTimeHN(t.created_at);
        const photoIcon = t.receipt_url ? ' üìé' : '';
        
        return `
            <div class="transaction-item" ${t.receipt_url ? `onclick="window.open('${t.receipt_url}','_blank')"` : ''}>
                <div class="transaction-icon" style="background: ${bgColor}">${icon}</div>
                <div class="transaction-info">
                    <div class="transaction-name">${t.description || catName}${photoIcon}</div>
                    <div class="transaction-category">${catName} ¬∑ ${dateDisplay} ¬∑ ${timeDisplay}</div>
                </div>
                <div class="transaction-amount ${amountClass}">${prefix}${fmt(t.amount)}</div>
            </div>
        `;
    }

    // ========================
    // ACCOUNTS PAGE
    // ========================
    function renderAccountsPage() {
        const filtered = currentAccountFilter === 'all' ? accounts : accounts.filter(a => a.type === currentAccountFilter);
        const container = document.getElementById('accounts-full-list');
        
        if (filtered.length === 0) {
            container.innerHTML = '<div class="empty-state"><span>üí≥</span><p>No hay cuentas de este tipo</p></div>';
            return;
        }

        container.innerHTML = filtered.map(a => {
            const goalHtml = a.type === 'savings' && a.goal_amount ? `
                <div style="margin-top: 10px;">
                    <div style="display:flex; justify-content:space-between; font-size:12px; color: var(--text-muted);">
                        <span>Meta: ${fmt(a.goal_amount)}</span>
                        <span>${Math.min(100, Math.round((a.balance / a.goal_amount) * 100))}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${Math.min(100, (a.balance / a.goal_amount) * 100)}%; background: var(--accent-success);"></div>
                    </div>
                </div>
            ` : '';

            return `
                <div class="card">
                    <div style="display:flex; align-items:center; gap:14px;">
                        <div style="font-size:32px;">${ACCOUNT_ICONS[a.type] || 'üí≥'}</div>
                        <div style="flex:1;">
                            <div style="font-weight:600; font-size:15px;">${a.name}</div>
                            <div style="font-size:12px; color:var(--text-muted); text-transform:capitalize;">${a.type === 'bank' ? 'Banco' : a.type === 'cash' ? 'Efectivo' : a.type === 'savings' ? 'Ahorro' : a.type}</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-family:var(--font-mono); font-size:18px; font-weight:700;">${fmt(a.balance)}</div>
                        </div>
                    </div>
                    ${goalHtml}
                </div>
            `;
        }).join('');
    }

    function filterAccounts(el, filter) {
        currentAccountFilter = filter;
        document.querySelectorAll('#account-type-tabs .tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        renderAccountsPage();
    }

    // ========================
    // TRANSACTIONS PAGE
    // ========================
    function renderTransactionsPage() {
        const filtered = currentTxFilter === 'all' ? transactions : transactions.filter(t => t.type === currentTxFilter);
        const container = document.getElementById('all-transactions');
        
        if (filtered.length === 0) {
            container.innerHTML = '<div class="empty-state"><span>üìù</span><p>No hay movimientos</p></div>';
            return;
        }

        // Group by date
        const groups = {};
        filtered.forEach(t => {
            const d = t.date;
            if (!groups[d]) groups[d] = [];
            groups[d].push(t);
        });

        container.innerHTML = Object.entries(groups).map(([date, txs]) => `
            <div style="margin-bottom: 16px;">
                <p style="font-size:12px; font-weight:600; color:var(--text-muted); margin-bottom:8px; text-transform:uppercase;">
                    ${formatFullDateHN(date + 'T12:00:00')}
                </p>
                ${txs.map(t => renderTransactionItem(t)).join('')}
            </div>
        `).join('');
    }

    function filterTransactions(el, filter) {
        currentTxFilter = filter;
        el.parentElement.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        renderTransactionsPage();
    }

    // ========================
    // TRANSACTION MODAL
    // ========================
    function openTransactionModal(type = 'income') {
        currentTxType = type;
        document.getElementById('tx-date').value = todayStr();
        document.getElementById('tx-time').value = nowTimeStr();
        document.getElementById('tx-amount').value = '';
        document.getElementById('tx-description').value = '';
        clearPhoto();
        
        // Reset save button state
        document.getElementById('btn-save-tx').disabled = false;
        document.getElementById('tx-saving-indicator').style.display = 'none';
        document.getElementById('tx-buttons').style.display = 'grid';
        
        // Set active tab
        document.querySelectorAll('#transaction-type-tabs .tab').forEach(t => t.classList.remove('active'));
        const tabs = document.querySelectorAll('#transaction-type-tabs .tab');
        if (type === 'income') tabs[0].classList.add('active');
        else if (type === 'expense') tabs[1].classList.add('active');
        else tabs[2].classList.add('active');

        updateTransactionForm();
        openModal('modal-transaction');
    }

    function setTransactionType(el, type) {
        currentTxType = type;
        el.parentElement.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        updateTransactionForm();
    }

    function updateTransactionForm() {
        const catGroup = document.getElementById('tx-category-group');
        const toAccGroup = document.getElementById('tx-to-account-group');
        const spiritualPreview = document.getElementById('tx-spiritual-preview');
        const accLabel = document.getElementById('tx-account-label');

        // Categories
        const filteredCats = categories.filter(c => c.type === (currentTxType === 'income' ? 'income' : 'expense'));
        document.getElementById('tx-category').innerHTML = filteredCats.map(c => 
            `<option value="${c.id}">${c.icon} ${c.name}</option>`
        ).join('');

        // Accounts
        const accOptions = accounts.map(a => `<option value="${a.id}">${ACCOUNT_ICONS[a.type]} ${a.name} (${fmt(a.balance)})</option>`).join('');
        document.getElementById('tx-account').innerHTML = accOptions;
        document.getElementById('tx-to-account').innerHTML = accOptions;

        if (currentTxType === 'transfer') {
            catGroup.style.display = 'none';
            toAccGroup.style.display = 'block';
            accLabel.textContent = 'Cuenta Origen';
            spiritualPreview.style.display = 'none';
        } else {
            catGroup.style.display = 'block';
            toAccGroup.style.display = 'none';
            accLabel.textContent = 'Cuenta';
            
            if (currentTxType === 'income' && userProfile?.spiritual_module_enabled) {
                spiritualPreview.style.display = 'block';
                document.getElementById('tx-tithe-pct').textContent = userProfile.tithe_percentage;
            } else {
                spiritualPreview.style.display = 'none';
            }
        }
    }

    // Update spiritual preview when amount changes
    document.getElementById('tx-amount').addEventListener('input', function() {
        if (currentTxType === 'income' && userProfile?.spiritual_module_enabled) {
            const amount = parseFloat(this.value) || 0;
            const tithe = amount * (userProfile.tithe_percentage / 100);
            document.getElementById('tx-tithe-amount').textContent = fmt(tithe);
            document.getElementById('tx-available-after').textContent = fmt(amount - tithe);
        }
    });

    async function saveTransaction() {
        try {
            const amount = parseFloat(document.getElementById('tx-amount').value);
            if (!amount || amount <= 0) return showToast('Ingresa un monto v√°lido', 'error');

            const description = document.getElementById('tx-description').value.trim();
            const date = document.getElementById('tx-date').value;
            const time = document.getElementById('tx-time').value || nowTimeStr();
            const accountId = document.getElementById('tx-account').value;

            if (!date) return showToast('Selecciona una fecha', 'error');
            if (!accountId) return showToast('Selecciona una cuenta', 'error');

            // Show loading state
            document.getElementById('btn-save-tx').disabled = true;
            document.getElementById('tx-saving-indicator').style.display = 'block';
            document.getElementById('tx-buttons').style.display = 'none';

            // Upload photo if exists
            let receiptUrl = null;
            if (currentPhotoFile) {
                receiptUrl = await uploadPhoto(currentPhotoFile);
            }

            if (currentTxType === 'transfer') {
                const toAccountId = document.getElementById('tx-to-account').value;
                if (!toAccountId) return resetSaveBtn('Selecciona cuenta destino');
                if (accountId === toAccountId) return resetSaveBtn('Selecciona cuentas diferentes');

                const { error } = await supabaseClient.from('transactions').insert([
                    { user_id: currentUser.id, account_id: accountId, type: 'transfer', amount: amount, description: description || 'Transferencia enviada', date, time, receipt_url: receiptUrl },
                    { user_id: currentUser.id, account_id: toAccountId, type: 'transfer', amount: amount, description: description || 'Transferencia recibida', date, time, receipt_url: receiptUrl }
                ]);
                if (error) return resetSaveBtn('Error: ' + error.message);

                // Update balances using RPC or direct update
                const fromAcc = accounts.find(a => a.id === accountId);
                const toAcc = accounts.find(a => a.id === toAccountId);
                if (fromAcc) {
                    await supabaseClient.from('accounts').update({ balance: parseFloat(fromAcc.balance) - amount }).eq('id', accountId);
                }
                if (toAcc) {
                    await supabaseClient.from('accounts').update({ balance: parseFloat(toAcc.balance) + amount }).eq('id', toAccountId);
                }

            } else {
                const categoryId = document.getElementById('tx-category').value;
                if (!categoryId && currentTxType !== 'transfer') return resetSaveBtn('Selecciona una categor√≠a');

                const txData = {
                    user_id: currentUser.id,
                    account_id: accountId,
                    category_id: categoryId || null,
                    type: currentTxType,
                    amount,
                    description,
                    date,
                    time,
                    receipt_url: receiptUrl
                };

                const { error } = await supabaseClient.from('transactions').insert(txData);
                if (error) return resetSaveBtn('Error: ' + error.message);

                // Update account balance
                const acc = accounts.find(a => a.id === accountId);
                if (acc) {
                    const newBalance = currentTxType === 'income'
                        ? parseFloat(acc.balance) + amount
                        : parseFloat(acc.balance) - amount;
                    await supabaseClient.from('accounts').update({ balance: newBalance }).eq('id', accountId);
                }

                // Spiritual allocation
                if (currentTxType === 'income' && userProfile?.spiritual_module_enabled) {
                    const titheAmount = amount * (userProfile.tithe_percentage / 100);
                    const titheAccount = accounts.find(a => a.type === 'tithe');
                    if (titheAccount) {
                        try {
                            await supabaseClient.from('spiritual_allocations').insert({
                                user_id: currentUser.id,
                                type: 'tithe',
                                amount: titheAmount,
                                target_account_id: titheAccount.id,
                                status: 'suggested'
                            });
                        } catch (e) {
                            console.warn('Spiritual allocation note saved:', e);
                        }
                    }
                }
            }

            closeModal('modal-transaction');
            currentPhotoFile = null;
            showToast(currentTxType === 'income' ? 'Ingreso registrado' : currentTxType === 'expense' ? 'Gasto registrado' : 'Transferencia realizada');
            await loadAllData();
        } catch (err) {
            console.error('saveTransaction error:', err);
            resetSaveBtn('Error inesperado: ' + err.message);
        }
    }

    function resetSaveBtn(errorMsg) {
        document.getElementById('btn-save-tx').disabled = false;
        document.getElementById('tx-saving-indicator').style.display = 'none';
        document.getElementById('tx-buttons').style.display = 'grid';
        if (errorMsg) showToast(errorMsg, 'error');
    }

    // ========================
    // ACCOUNTS MODAL
    // ========================
    function openAccountModal() {
        document.getElementById('acc-name').value = '';
        document.getElementById('acc-balance').value = '';
        document.getElementById('acc-goal').value = '';
        openModal('modal-account');
    }

    async function saveAccount() {
        const name = document.getElementById('acc-name').value.trim();
        const type = document.getElementById('acc-type').value;
        const balance = parseFloat(document.getElementById('acc-balance').value) || 0;
        const goal = parseFloat(document.getElementById('acc-goal').value) || null;

        if (!name) return showToast('Ingresa un nombre', 'error');

        const { error } = await supabaseClient.from('accounts').insert({
            user_id: currentUser.id,
            name,
            type,
            balance,
            goal_amount: type === 'savings' ? goal : null,
            icon: ACCOUNT_ICONS[type] || 'üí≥',
            color: '#818cf8',
            is_active: true
        });

        if (error) return showToast('Error: ' + error.message, 'error');
        closeModal('modal-account');
        showToast('Cuenta creada');
        await loadAccounts();
        renderDashboard();
        if (currentPage === 'accounts') renderAccountsPage();
    }

    // ========================
    // DEBTS
    // ========================
    function renderDebtsPage() {
        const activeDebts = debts.filter(d => d.status === 'active');
        const totalDebt = activeDebts.reduce((s, d) => s + parseFloat(d.current_balance || 0), 0);
        const monthlyPayment = activeDebts.reduce((s, d) => s + parseFloat(d.monthly_payment || 0), 0);

        document.getElementById('total-debt').textContent = fmt(totalDebt);
        document.getElementById('monthly-debt-payment').textContent = fmt(monthlyPayment);

        const container = document.getElementById('debts-list');
        if (debts.length === 0) {
            container.innerHTML = '<div class="empty-state"><span>üéâ</span><p>¬°Sin deudas! Excelente mayordom√≠a.</p></div>';
            return;
        }

        container.innerHTML = debts.map(d => {
            const progress = d.original_amount > 0 ? ((d.original_amount - d.current_balance) / d.original_amount) * 100 : 0;
            const progressColor = d.status === 'paid_off' ? 'var(--accent-success)' : progress > 50 ? 'var(--accent-warning)' : 'var(--accent-danger)';

            return `
                <div class="debt-card">
                    <div class="debt-header">
                        <div class="debt-creditor">${d.creditor_name}</div>
                        <span class="debt-badge ${d.status === 'paid_off' ? 'paid' : 'active'}">${d.status === 'paid_off' ? 'Pagada' : 'Activa'}</span>
                    </div>
                    <div class="debt-info">
                        <div class="debt-info-item">
                            <small>Saldo</small>
                            <p style="color: var(--accent-danger);">${fmt(d.current_balance)}</p>
                        </div>
                        <div class="debt-info-item">
                            <small>Cuota</small>
                            <p>${fmt(d.monthly_payment)}</p>
                        </div>
                        <div class="debt-info-item">
                            <small>Monto Original</small>
                            <p>${fmt(d.original_amount)}</p>
                        </div>
                        <div class="debt-info-item">
                            <small>D√≠a de Pago</small>
                            <p>${d.due_day || '-'}</p>
                        </div>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <div style="display:flex; justify-content:space-between; font-size:12px; color:var(--text-muted); margin-bottom:4px;">
                            <span>Progreso</span>
                            <span>${Math.round(progress)}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%; background: ${progressColor};"></div>
                        </div>
                    </div>
                    ${d.status === 'active' ? `<button class="btn btn-sm btn-secondary" onclick="openDebtPaymentModal('${d.id}')">üí∞ Registrar Abono</button>` : ''}
                </div>
            `;
        }).join('');
    }

    function openDebtModal() {
        document.getElementById('debt-creditor').value = '';
        document.getElementById('debt-original').value = '';
        document.getElementById('debt-balance').value = '';
        document.getElementById('debt-interest').value = '';
        document.getElementById('debt-payment').value = '';
        document.getElementById('debt-due-day').value = '';
        openModal('modal-debt');
    }

    async function saveDebt() {
        const creditor = document.getElementById('debt-creditor').value.trim();
        const original = parseFloat(document.getElementById('debt-original').value);
        const balance = parseFloat(document.getElementById('debt-balance').value);
        const interest = parseFloat(document.getElementById('debt-interest').value) || 0;
        const payment = parseFloat(document.getElementById('debt-payment').value) || 0;
        const dueDay = parseInt(document.getElementById('debt-due-day').value) || 15;

        if (!creditor || !original || !balance) return showToast('Completa los campos requeridos', 'error');

        const { error } = await supabaseClient.from('debts').insert({
            user_id: currentUser.id,
            creditor_name: creditor,
            original_amount: original,
            current_balance: balance,
            interest_rate: interest,
            monthly_payment: payment,
            due_day: dueDay,
            status: 'active'
        });

        if (error) return showToast('Error: ' + error.message, 'error');
        closeModal('modal-debt');
        showToast('Deuda registrada');
        await loadDebts();
        renderDebtsPage();
    }

    function openDebtPaymentModal(debtId) {
        document.getElementById('dp-debt-id').value = debtId;
        document.getElementById('dp-amount').value = '';
        document.getElementById('dp-note').value = '';
        
        const accOptions = accounts.filter(a => !['tithe', 'offering', 'firstfruits'].includes(a.type))
            .map(a => `<option value="${a.id}">${ACCOUNT_ICONS[a.type]} ${a.name} (${fmt(a.balance)})</option>`).join('');
        document.getElementById('dp-account').innerHTML = accOptions;
        
        openModal('modal-debt-payment');
    }

    async function saveDebtPayment() {
        const debtId = document.getElementById('dp-debt-id').value;
        const amount = parseFloat(document.getElementById('dp-amount').value);
        const accountId = document.getElementById('dp-account').value;
        const note = document.getElementById('dp-note').value.trim();

        if (!amount || amount <= 0) return showToast('Ingresa un monto v√°lido', 'error');

        const debt = debts.find(d => d.id === debtId);
        if (!debt) return showToast('Deuda no encontrada', 'error');

        // Create payment record
        const { error } = await supabaseClient.from('debt_payments').insert({
            debt_id: debtId,
            amount,
            payment_date: todayStr(),
            account_id: accountId,
            note
        });
        if (error) return showToast('Error: ' + error.message, 'error');

        // Update debt balance
        const newBalance = Math.max(0, parseFloat(debt.current_balance) - amount);
        const updates = { current_balance: newBalance };
        if (newBalance <= 0) updates.status = 'paid_off';
        await supabaseClient.from('debts').update(updates).eq('id', debtId);

        // Update account balance
        const acc = accounts.find(a => a.id === accountId);
        await supabaseClient.from('accounts').update({ balance: parseFloat(acc.balance) - amount }).eq('id', accountId);

        // Also create expense transaction for the payment
        const preCat = categories.find(c => c.name === 'Pr√©stamo');
        await supabaseClient.from('transactions').insert({
            user_id: currentUser.id,
            account_id: accountId,
            category_id: preCat?.id,
            type: 'expense',
            amount,
            description: `Abono: ${debt.creditor_name}`,
            date: todayStr(),
            time: nowTimeStr()
        });

        closeModal('modal-debt-payment');
        showToast(newBalance <= 0 ? 'üéâ ¬°Deuda pagada completamente!' : 'Abono registrado');
        await loadAllData();
        renderDebtsPage();
    }

    // ========================
    // BUDGETS
    // ========================
    function renderBudgetsPage() {
        const container = document.getElementById('budgets-list');
        if (budgets.length === 0) {
            container.innerHTML = '<div class="empty-state"><span>üìä</span><p>No hay presupuestos para este mes</p></div>';
            return;
        }

        const { start, end } = getMonthRange();
        const monthExpenses = transactions.filter(t => t.type === 'expense' && t.date >= start && t.date <= end);

        container.innerHTML = budgets.map(b => {
            const spent = monthExpenses.filter(t => t.category_id === b.category_id).reduce((s, t) => s + parseFloat(t.amount), 0);
            const pct = b.amount > 0 ? (spent / b.amount) * 100 : 0;
            const color = pct >= 100 ? 'var(--accent-danger)' : pct >= 80 ? 'var(--accent-warning)' : 'var(--accent-success)';

            return `
                <div class="budget-item">
                    <div class="budget-item-header">
                        <div class="budget-item-name">${b.categories?.icon || 'üìù'} ${b.categories?.name || 'Sin categor√≠a'}</div>
                        <div class="budget-item-amounts">${fmt(spent)} / ${fmt(b.amount)}</div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${Math.min(100, pct)}%; background: ${color};"></div>
                    </div>
                    <p style="font-size:11px; color:${color}; margin-top:4px; text-align:right;">${Math.round(pct)}% utilizado</p>
                </div>
            `;
        }).join('');
    }

    function openBudgetModal() {
        const expenseCats = categories.filter(c => c.type === 'expense');
        document.getElementById('budget-category').innerHTML = expenseCats.map(c => 
            `<option value="${c.id}">${c.icon} ${c.name}</option>`
        ).join('');
        document.getElementById('budget-amount').value = '';
        openModal('modal-budget');
    }

    async function saveBudget() {
        const categoryId = document.getElementById('budget-category').value;
        const amount = parseFloat(document.getElementById('budget-amount').value);
        if (!amount || amount <= 0) return showToast('Ingresa un monto', 'error');

        const now = new Date();
        const { error } = await supabaseClient.from('budgets').insert({
            user_id: currentUser.id,
            category_id: categoryId,
            amount,
            period: 'monthly',
            month: now.getMonth() + 1,
            year: now.getFullYear()
        });

        if (error) return showToast('Error: ' + error.message, 'error');
        closeModal('modal-budget');
        showToast('Presupuesto creado');
        await loadBudgets();
        renderBudgetsPage();
    }

    // ========================
    // REPORTS
    // ========================
    function setReportPeriod(el, period) {
        reportPeriod = period;
        el.parentElement.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        renderReports();
    }

    function renderReports() {
        const container = document.getElementById('reports-content');
        const now = new Date();
        let filteredTx;

        if (reportPeriod === 'week') {
            const weekAgo = new Date(now);
            weekAgo.setDate(weekAgo.getDate() - 7);
            filteredTx = transactions.filter(t => new Date(t.date) >= weekAgo);
        } else if (reportPeriod === 'year') {
            const yearStart = new Date(now.getFullYear(), 0, 1);
            filteredTx = transactions.filter(t => new Date(t.date) >= yearStart);
        } else {
            const { start, end } = getMonthRange();
            filteredTx = transactions.filter(t => t.date >= start && t.date <= end);
        }

        const income = filteredTx.filter(t => t.type === 'income').reduce((s, t) => s + parseFloat(t.amount), 0);
        const expenses = filteredTx.filter(t => t.type === 'expense').reduce((s, t) => s + parseFloat(t.amount), 0);
        const net = income - expenses;

        // Expense by category
        const expByCategory = {};
        filteredTx.filter(t => t.type === 'expense').forEach(t => {
            const cat = categories.find(c => c.id === t.category_id);
            const name = cat?.name || 'Otro';
            const icon = cat?.icon || 'üìù';
            if (!expByCategory[name]) expByCategory[name] = { amount: 0, icon };
            expByCategory[name].amount += parseFloat(t.amount);
        });

        const sortedCats = Object.entries(expByCategory).sort((a, b) => b[1].amount - a[1].amount);
        const colors = ['#22d3ee', '#818cf8', '#34d399', '#fbbf24', '#f87171', '#c084fc', '#fb923c', '#a78bfa', '#38bdf8', '#4ade80'];

        // Build donut chart with SVG
        let donutSVG = '';
        if (sortedCats.length > 0) {
            let cumulative = 0;
            const segments = sortedCats.map(([name, data], i) => {
                const pct = expenses > 0 ? (data.amount / expenses) * 100 : 0;
                const offset = cumulative;
                cumulative += pct;
                return { name, pct, offset, color: colors[i % colors.length], amount: data.amount, icon: data.icon };
            });

            donutSVG = `
                <div class="donut-chart">
                    <svg viewBox="0 0 42 42" style="width:100%;height:100%;transform:rotate(-90deg);">
                        ${segments.map(s => `
                            <circle cx="21" cy="21" r="15.91549" fill="transparent" stroke="${s.color}" stroke-width="5"
                                stroke-dasharray="${s.pct} ${100 - s.pct}" stroke-dashoffset="-${s.offset}" />
                        `).join('')}
                    </svg>
                    <div class="donut-center">
                        <div class="amount">${fmt(expenses)}</div>
                        <small>Total Gastos</small>
                    </div>
                </div>
            `;
        }

        const periodLabel = reportPeriod === 'week' ? 'esta semana' : reportPeriod === 'year' ? 'este a√±o' : 'este mes';

        container.innerHTML = `
            <div class="chart-container">
                <h4 style="font-size:14px; margin-bottom:16px;">Resumen ${periodLabel}</h4>
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin-bottom:20px;">
                    <div style="text-align:center;">
                        <p style="font-size:11px; color:var(--text-muted);">Ingresos</p>
                        <p style="font-family:var(--font-mono); font-weight:700; color:var(--accent-success);">${fmt(income)}</p>
                    </div>
                    <div style="text-align:center;">
                        <p style="font-size:11px; color:var(--text-muted);">Gastos</p>
                        <p style="font-family:var(--font-mono); font-weight:700; color:var(--accent-danger);">${fmt(expenses)}</p>
                    </div>
                    <div style="text-align:center;">
                        <p style="font-size:11px; color:var(--text-muted);">Neto</p>
                        <p style="font-family:var(--font-mono); font-weight:700; color:${net >= 0 ? 'var(--accent-success)' : 'var(--accent-danger)'};">${fmt(net)}</p>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <h4 style="font-size:14px; margin-bottom:16px;">Gastos por Categor√≠a</h4>
                ${expenses > 0 ? donutSVG : '<div class="empty-state"><p>Sin gastos en este per√≠odo</p></div>'}
                <div style="margin-top:12px;">
                    ${sortedCats.map(([name, data], i) => `
                        <div class="legend-item">
                            <div class="legend-color" style="background:${colors[i % colors.length]}"></div>
                            <span class="legend-label">${data.icon} ${name}</span>
                            <span class="legend-value">${fmt(data.amount)}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    // ========================
    // FAMILY MODULE
    // ========================
    let familyData = null;
    let familyMembers = [];

    async function loadFamilyData() {
        try {
            const { data: memberData } = await supabaseClient.from('family_members')
                .select('*, families(*)')
                .eq('user_id', currentUser.id)
                .maybeSingle();

            if (memberData && memberData.families) {
                familyData = memberData.families;
                familyData.myRole = memberData.role;

                const { data: members } = await supabaseClient.from('family_members')
                    .select('*, users(id, full_name, email, currency)')
                    .eq('family_id', familyData.id);
                familyMembers = members || [];
            } else {
                familyData = null;
                familyMembers = [];
            }
        } catch (e) {
            console.warn('Family load skipped:', e);
            familyData = null;
            familyMembers = [];
        }
    }

    async function renderFamilyPage() {
        await loadFamilyData();

        if (!familyData) {
            document.getElementById('family-no-group').style.display = 'block';
            document.getElementById('family-group').style.display = 'none';
            renderFamilySettings();
            return;
        }

        document.getElementById('family-no-group').style.display = 'none';
        document.getElementById('family-group').style.display = 'block';
        document.getElementById('family-name').textContent = familyData.name;
        document.getElementById('family-invite-code').textContent = familyData.invite_code;

        // Render members
        const membersList = document.getElementById('family-members-list');
        membersList.innerHTML = familyMembers.map(m => `
            <div class="card" style="margin-bottom:8px;padding:14px;">
                <div style="display:flex;align-items:center;gap:12px;">
                    <div style="width:40px;height:40px;border-radius:50%;background:${m.user_id === currentUser.id ? 'var(--accent-primary)' : 'var(--bg-input)'};display:flex;align-items:center;justify-content:center;font-size:18px;">
                        ${m.user_id === currentUser.id ? 'üë§' : 'üë•'}
                    </div>
                    <div style="flex:1;">
                        <p style="font-weight:600;font-size:14px;">
                            ${m.users?.full_name || m.users?.email || 'Usuario'}
                            ${m.user_id === currentUser.id ? ' (T√∫)' : ''}
                        </p>
                        <p style="font-size:12px;color:var(--text-muted);">${m.role === 'admin' ? 'üëë Administrador' : 'üë§ Miembro'}</p>
                    </div>
                </div>
            </div>
        `).join('');

        // Load family financial summary
        await loadFamilySummary();
        renderFamilySettings();
    }

    async function loadFamilySummary() {
        let totalBalance = 0;
        let totalDebt = 0;
        const summariesHtml = [];

        for (const member of familyMembers) {
            const uid = member.user_id;
            const name = member.users?.full_name || 'Usuario';

            try {
                const { data: summaryData } = await supabaseClient.rpc('get_family_member_summary', {
                    p_member_id: uid,
                    p_month_start: getMonthRange().start,
                    p_month_end: getMonthRange().end
                });

                const s = summaryData || { balance: 0, debt: 0, income: 0, expenses: 0 };
                totalBalance += parseFloat(s.balance || 0);
                totalDebt += parseFloat(s.debt || 0);

                summariesHtml.push(`
                    <div class="card" style="margin-bottom:10px;">
                        <p style="font-weight:600;font-size:14px;margin-bottom:10px;">
                            ${uid === currentUser.id ? 'üë§' : 'üë•'} ${name}
                        </p>
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;">
                            <div>
                                <p style="font-size:11px;color:var(--text-muted);">Balance</p>
                                <p style="font-family:var(--font-mono);font-size:13px;font-weight:700;color:var(--accent-primary);">${fmt(s.balance)}</p>
                            </div>
                            <div>
                                <p style="font-size:11px;color:var(--text-muted);">Ingresos</p>
                                <p style="font-family:var(--font-mono);font-size:13px;font-weight:700;color:var(--accent-success);">${fmt(s.income)}</p>
                            </div>
                            <div>
                                <p style="font-size:11px;color:var(--text-muted);">Gastos</p>
                                <p style="font-family:var(--font-mono);font-size:13px;font-weight:700;color:var(--accent-danger);">${fmt(s.expenses)}</p>
                            </div>
                        </div>
                    </div>
                `);
            } catch (e) {
                console.warn('Error loading member summary:', e);
                summariesHtml.push(`
                    <div class="card" style="margin-bottom:10px;">
                        <p style="font-weight:600;font-size:14px;">${uid === currentUser.id ? 'üë§' : 'üë•'} ${name}</p>
                        <p style="font-size:12px;color:var(--text-muted);">No se pudieron cargar los datos</p>
                    </div>
                `);
            }
        }

        document.getElementById('family-total-balance').textContent = fmt(totalBalance);
        document.getElementById('family-total-debt').textContent = fmt(totalDebt);
        document.getElementById('family-member-summaries').innerHTML = summariesHtml.join('');
    }

    function renderFamilySettings() {
        const container = document.getElementById('family-settings-content');
        if (familyData) {
            container.innerHTML = `
                <div class="settings-item" onclick="navigateTo('family')">
                    <span>üè†</span>
                    <p>${familyData.name}</p>
                    <span style="color: var(--text-muted)">‚Ä∫</span>
                </div>
            `;
        } else {
            container.innerHTML = `
                <div class="settings-item" onclick="openCreateFamilyModal()">
                    <span>‚ûï</span>
                    <p>Crear Familia</p>
                    <span style="color: var(--text-muted)">‚Ä∫</span>
                </div>
                <div class="settings-item" onclick="openJoinFamilyModal()">
                    <span>üîó</span>
                    <p>Unirse a Familia</p>
                    <span style="color: var(--text-muted)">‚Ä∫</span>
                </div>
            `;
        }
    }

    function openCreateFamilyModal() {
        document.getElementById('family-create-name').value = '';
        openModal('modal-create-family');
    }

    function openJoinFamilyModal() {
        document.getElementById('family-join-code').value = '';
        openModal('modal-join-family');
    }

    async function createFamily() {
        const name = document.getElementById('family-create-name').value.trim();
        if (!name) return showToast('Ingresa un nombre para la familia', 'error');

        const { data: family, error } = await supabaseClient.from('families').insert({
            name,
            created_by: currentUser.id
        }).select().single();

        if (error) return showToast('Error: ' + error.message, 'error');

        // Add creator as admin
        await supabaseClient.from('family_members').insert({
            family_id: family.id,
            user_id: currentUser.id,
            role: 'admin'
        });

        // Update user profile
        await supabaseClient.from('users').update({ family_id: family.id }).eq('id', currentUser.id);

        closeModal('modal-create-family');
        showToast('üè† ¬°Familia creada! Comparte el c√≥digo con tus familiares.');
        navigateTo('family');
    }

    async function joinFamily() {
        const code = document.getElementById('family-join-code').value.trim().toLowerCase();
        if (!code) return showToast('Ingresa el c√≥digo', 'error');

        const { data: result, error } = await supabaseClient.rpc('join_family_by_code', {
            p_invite_code: code
        });

        if (error) return showToast('Error: ' + error.message, 'error');
        if (!result.success) return showToast(result.message, 'error');

        closeModal('modal-join-family');
        showToast(`üéâ ¬°Te uniste a ${result.family_name}!`);
        navigateTo('family');
    }

    function copyInviteCode() {
        const code = document.getElementById('family-invite-code').textContent;
        navigator.clipboard.writeText(code).then(() => {
            showToast('üìã C√≥digo copiado');
        }).catch(() => {
            // Fallback
            const temp = document.createElement('input');
            temp.value = code;
            document.body.appendChild(temp);
            temp.select();
            document.execCommand('copy');
            document.body.removeChild(temp);
            showToast('üìã C√≥digo copiado');
        });
    }

    // ========================
    // SETTINGS
    // ========================
    function updateSettingsUI() {
        if (!userProfile) return;
        document.getElementById('settings-currency').textContent = userProfile.currency;
        document.getElementById('settings-spiritual').checked = userProfile.spiritual_module_enabled;
        document.getElementById('settings-tithe').textContent = userProfile.tithe_percentage;
        document.getElementById('settings-spiritual-options').style.display = userProfile.spiritual_module_enabled ? 'block' : 'none';
        renderFamilySettings();
    }

    async function toggleSpiritual(enabled) {
        await supabaseClient.from('users').update({ spiritual_module_enabled: enabled }).eq('id', currentUser.id);
        userProfile.spiritual_module_enabled = enabled;
        document.getElementById('settings-spiritual-options').style.display = enabled ? 'block' : 'none';
        renderDashboard();
    }

    function openCategoriesManager() {
        showToast('Gesti√≥n de categor√≠as pr√≥ximamente');
    }

    function openProfileEdit() {
        showToast('Edici√≥n de perfil pr√≥ximamente');
    }

    function showNotificationsPanel() {
        // Check upcoming debt payments
        const today = new Date().getDate();
        const upcoming = debts.filter(d => d.status === 'active' && Math.abs(d.due_day - today) <= 3);
        if (upcoming.length > 0) {
            showToast(`‚ö†Ô∏è ${upcoming.length} pago(s) de deuda pr√≥ximos`);
        } else {
            showToast('No hay notificaciones pendientes');
        }
    }

    // ========================
    // INITIALIZATION
    // ========================
    async function init() {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session) {
            currentUser = session.user;
            await checkProfile();
        }

        // Listen for auth changes
        supabaseClient.auth.onAuthStateChange(async (event, session) => {
            if (event === 'SIGNED_IN' && session) {
                currentUser = session.user;
                await checkProfile();
            } else if (event === 'SIGNED_OUT') {
                currentUser = null;
                userProfile = null;
            }
        });
    }

    // Close modals on overlay click
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.classList.remove('active');
        });
    });

    // Register Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('SW registered:', reg.scope))
                .catch(err => console.log('SW error:', err));
        });
    }

    // Request notification permission
    if ('Notification' in window && Notification.permission === 'default') {
        setTimeout(() => {
            Notification.requestPermission();
        }, 5000);
    }

    // Check for upcoming debt payments and notify
    function checkDebtNotifications() {
        if (!('Notification' in window) || Notification.permission !== 'granted') return;
        const today = new Date().getDate();
        const upcoming = debts.filter(d => d.status === 'active' && d.due_day);
        upcoming.forEach(d => {
            const diff = d.due_day - today;
            if (diff >= 0 && diff <= 3) {
                new Notification('üí∞ Pago Pr√≥ximo', {
                    body: `${d.creditor_name}: ${fmt(d.monthly_payment)} - D√≠a ${d.due_day}`,
                    icon: 'üí∞',
                    tag: `debt-${d.id}`
                });
            }
        });
    }

    init();
    </script>
</body>
</html>
